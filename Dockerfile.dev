FROM node:18-alpine

# 设置工作目录
WORKDIR /app

# 设置npm镜像和超时配置
RUN npm config set registry https://registry.npmmirror.com/ && \
    npm config set fetch-timeout 600000 && \
    npm config set fetch-retries 5

# 安装 ts-node 和依赖
RUN npm install -g ts-node pnpm nodemon

# 复制 package.json 和 pnpm-lock.yaml
COPY package.json pnpm-lock.yaml ./
COPY nodemon.json ./

# 安装依赖，增加重试和超时设置
RUN pnpm config set registry https://registry.npmmirror.com/ && \
    pnpm install --frozen-lockfile

# 复制源代码 (注意：在开发模式中，这些文件会被卷挂载覆盖)
COPY src/ ./src/
# 没有顶级config目录，删除这行
COPY tsconfig.json .
COPY .env* ./
COPY public/ ./public/

# 暴露端口
EXPOSE 3010

# 启动命令 - 开发模式下使用 nodemon 监控文件变化
CMD ["pnpm", "run", "dev"] 